<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>出発時間の共有</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg:#f7f7fb; --ink:#222; --muted:#6b7280;
  --brand:#ff7043; --accent:#2563eb;
  --grid:#e5e7eb; --major:#cdd3da;
  --card-ink:#fff; --shadow:0 6px 18px rgba(0,0,0,.08);
  --radius:14px; --col-gap:10px;
  --px-per-min:2.6;          /* 1分=2.6px → 150分=約390px */
  /* 列カラー */
  --col0:#e6f0ff; --card0:#3b82f6; /* のすけ */
  --col1:#ffe7ee; --card1:#ef476f; /* ママ   */
  --col2:#e7fbf5; --card2:#06d6a0; /* そう   */
  --col3:#fff3df; --card3:#ffa600; /* しゅう */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; height:100svh; overflow:hidden;               /* 画面全体はスクロールしない */
  padding-top:calc(env(safe-area-inset-top) + 6px);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",Arial,sans-serif;
  background:var(--bg); color:var(--ink);
  -webkit-user-select:none; user-select:none;             /* テキスト選択禁止（D&DはJSで扱う） */
}
.app{
  height:100%; max-width:1100px; margin:0 auto;
  padding:8px 10px calc(env(safe-area-inset-bottom) + 12px);
  display:flex; flex-direction:column; gap:8px;
}

/* ヘッダー */
.header{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
.title{
  background:#fff; border-radius:12px; box-shadow:var(--shadow);
  padding:6px 10px; min-height:44px;
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
.place{ font-weight:800; color:#111; font-size:15px; min-width:180px; }
.departWrap{ display:flex; align-items:center; gap:8px; }
.departLabel{ font-weight:900; letter-spacing:.03em; }
.departUnset{ color:#9ca3af; font-weight:800; }
.departSet{ color:var(--brand); font-weight:900; font-size:18px; }
.countdown{font-weight:800; color:#111; font-variant-numeric:tabular-nums;}
.controls{ display:flex; gap:8px; align-items:center; }
.btn{
  appearance:none; border:0; border-radius:10px; padding:8px 12px; font-weight:600; background:#fff;
  box-shadow:var(--shadow); color:#222; font-size:14px; white-space:nowrap;
}
.btn.primary{ background:var(--brand); color:#fff }
.btn.ghost{ background:transparent; border:1px solid var(--grid) }
.input{
  background:#fff; box-shadow:var(--shadow); border-radius:10px; padding:8px 10px; border:1px solid transparent; font-size:14px;
}

/* タイムライン */
.gridwrap{
  position:relative; flex:1; min-height:260px;
  background:#fff; border-radius:var(--radius); box-shadow:var(--shadow);
  padding:8px; overflow:hidden;
}
.grid{
  position:relative;
  display:grid;
  grid-template-columns:56px repeat(4,1fr);   /* 左：時刻列＋メンバー列 */
  gap:var(--col-gap);
  height:390px;                                /* JSで上書き */
}

/* 左の時刻列：ここだけ縦スクロール可 */
.timeAxis{ position:relative; z-index:4; background:#fff; overflow:hidden; }
.timeScroll{
  position:absolute; inset:0;
  overflow:auto; -webkit-overflow-scrolling:touch;
  touch-action:pan-y;                             /* ← ここは縦スクロールOK */
}
.timeSpacer{ width:100%; height:100%; }          /* スクロール量のためのスペーサ */
.timeLabels{ position:absolute; inset:0; pointer-events:none; }
.timeLabel{
  position:absolute; left:4px; font-size:12px; color:#6b7280; font-weight:700;
  background:#fff; padding:0 2px; border-radius:4px; transform:translateY(-9px);
}

/* 横ライン（全カラムへ延長） */
.linesLayer{ position:absolute; inset:0; z-index:1; pointer-events:none; }
.rowLine{ position:absolute; left:0; right:0; height:1px; background:var(--grid); }
.rowLine.major{ background:var(--major); height:1.5px; } /* 00/30分は太め */

/* メンバー列（列自体はスクロール不可） */
.memberCol{
  position:relative; border-left:1px dashed var(--grid); border-right:1px dashed var(--grid);
  border-radius:8px; overflow:visible; min-width:0;
}
.memberCol[data-index="0"]{ background:var(--col0); }
.memberCol[data-index="1"]{ background:var(--col1); }
.memberCol[data-index="2"]{ background:var(--col2); }
.memberCol[data-index="3"]{ background:var(--col3); }
.memberHead{
  position:sticky; top:0; z-index:3; background:rgba(255,255,255,.92); backdrop-filter:saturate(120%) blur(3px);
  color:#1f2937; font-weight:900; text-align:center; padding:6px 6px; border-radius:6px; margin:6px;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.colBody{
  position:absolute; left:0; right:0; top:0; height:100%;
  will-change:transform; touch-action:none;          /* ← 縦スクロール不可。D&DはOK */
}

/* カード（アイコンのみ） */
.card{
  position:absolute; left:4px; right:4px;
  min-height: calc(var(--px-per-min) * 10);
  color:var(--card-ink);
  border-radius:12px; padding:6px 8px;
  font-weight:900; font-size:18px; line-height:1; text-align:center;
  box-shadow:0 8px 14px rgba(0,0,0,.15);
  touch-action:none; user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  z-index:2;
}
.card .icon{ display:block; pointer-events:none; }
.card .resize{ position:absolute; left:0; right:0; bottom:-6px; height:12px; cursor:ns-resize; }
.card.dragging{opacity:.92; outline:2px solid rgba(255,255,255,.6)}
.card.ghost{opacity:.6}
.card{ transition:transform .15s ease; }
.card .delBtn{ display:none; }
.card.swipeLeft{ transform:translateX(-60px); }
.card.swipeLeft .delBtn{ display:block; }
.card .delBtn{
  position:absolute; top:50%; right:-54px; transform:translateY(-50%);
  background:#ef4444; color:#fff; border:none; border-radius:10px; padding:8px 10px; font-weight:800;
  box-shadow:0 6px 12px rgba(239,68,68,.35);
}

/* 現在・出発ライン */
.departLine,.nowLine{ position:absolute; left:0; right:0; height:2px; z-index:5; }
.departLine{ background:var(--brand) }
.nowLine{ background:var(--accent) }
.departHandle{
  position:absolute; right:6px; top:-10px; background:var(--brand); color:#fff; padding:6px 10px; border-radius:8px;
  font-weight:900; font-size:13px; box-shadow:var(--shadow); touch-action:none; user-select:none; z-index:6;
}

/* タスクパレット：2行固定＋横スクロール、追加ボタンは一行で横長 */
.palette{ background:#111827; color:#e5e7eb; border-radius:16px; padding:10px; box-shadow:var(--shadow); }
.tags{
  display:grid; grid-auto-flow:column; grid-auto-rows:40px; grid-template-rows:repeat(2,40px);
  gap:8px 8px; overflow-x:auto; overflow-y:hidden; height:calc(40px*2 + 8px);
  padding-bottom:2px; -webkit-overflow-scrolling:touch;
}
.tag{
  background:#3b82f6; color:#fff; padding:8px 10px; border-radius:999px; font-weight:700; font-size:14px;
  box-shadow:0 6px 12px rgba(59,130,246,.3); touch-action:none; user-select:none; white-space:nowrap;
}
.tag:active{transform:scale(.98)}
.toolbar{ display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap:nowrap; }
#addTaskBtn{ flex:0 0 auto; padding:10px 18px; white-space:nowrap; }  /* ← 1行確定 */
.small{font-size:12px; color:#cbd5e1}

/* トースト／アラーム／モーダル */
.toast{
  position:fixed; left:50%; bottom:calc(12px + env(safe-area-inset-bottom)); transform:translateX(-50%);
  background:#111827; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow); font-weight:700; z-index:100; opacity:0; pointer-events:none; transition:opacity .2s;
}
.toast.show{opacity:1}
.alarm{
  position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:120; display:none; align-items:center; justify-content:center;
}
.alarm .panel{
  background:#fff; border-radius:16px; padding:18px; width:min(86vw,420px); text-align:center; box-shadow:0 14px 40px rgba(0,0,0,.2);
}
.alarm .panel .msg{ font-size:28px; font-weight:900; margin-bottom:6px; }
.alarm .panel .sub{ color:#555; margin-bottom:14px; }
.alarm .panel .ok{ background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:800; }

.modal{
  position:fixed; inset:0; z-index:110; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.45);
}
.modal .box{
  background:#fff; border-radius:14px; padding:14px; width:min(90vw,420px); box-shadow:0 14px 40px rgba(0,0,0,.18);
}
.modal .row{display:flex; gap:8px; align-items:center; margin:8px 0}
.modal .ok{ background:var(--brand); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:800; }
.modal .close{ background:#e5e7eb; color:#111; border:none; border-radius:10px; padding:10px 14px; font-weight:700; }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <input class="input place" id="place" placeholder="行き先（例：イオンモール）">
      <div class="departWrap">
        <span class="departLabel">出発</span>
        <button class="btn" id="openDepart" type="button">
          <span id="departText" class="departUnset">設定</span>
        </button>
        <span class="countdown" id="countdown">--:--</span>
      </div>
    </div>
    <div class="controls">
      <button class="btn ghost" id="resetBtn" type="button">全削除</button>
      <button class="btn primary" id="shareBtn" type="button">共有リンク</button>
    </div>
  </div>

  <div class="gridwrap" id="gridwrap">
    <div id="grid" class="grid">
      <!-- 左：時刻エリア（縦スクロール可） -->
      <div class="timeAxis">
        <div class="timeScroll" id="timeScroll"><div class="timeSpacer" id="timeSpacer"></div></div>
        <div class="timeLabels" id="timeLabels"></div>
      </div>

      <!-- メンバー列（スクロール不可／中身だけ同期） -->
      <div class="memberCol" data-index="0"><div class="memberHead">のすけ</div><div class="colBody"></div></div>
      <div class="memberCol" data-index="1"><div class="memberHead">ママ</div><div class="colBody"></div></div>
      <div class="memberCol" data-index="2"><div class="memberHead">そう</div><div class="colBody"></div></div>
      <div class="memberCol" data-index="3"><div class="memberHead">しゅう</div><div class="colBody"></div></div>

      <!-- 全面ライン（横） -->
      <div class="linesLayer" id="linesLayer"></div>

      <!-- 出発・現在ライン -->
      <div class="departLine" id="departLine"></div>
      <div class="nowLine" id="nowLine"></div>
      <div class="departHandle" id="departHandle">出発</div>
    </div>
  </div>

  <div class="palette" id="palette">
    <div class="tags" id="tags"></div>
    <div class="toolbar">
      <button class="btn" id="addTaskBtn" type="button">＋ タスクを追加</button>
      <span class="small">※ 長押しでパレット削除／タイムラインは左スワイプで削除</span>
    </div>
  </div>
</div>

<!-- トースト -->
<div class="toast" id="toast"></div>

<!-- 出発時間の設定モーダル（1タップで開く） -->
<div class="modal" id="depModal">
  <div class="box">
    <div style="font-weight:900;margin-bottom:6px;">出発時間の設定</div>
    <div class="row">
      <input class="input" id="departInput" type="time" step="600" style="font-weight:900;width:120px">
      <span class="small">※10分単位</span>
    </div>
    <div class="row">
      <button class="ok" id="depOk" type="button">完了</button>
      <button class="close" id="depCancel" type="button">キャンセル</button>
    </div>
  </div>
</div>

<!-- タスク追加モーダル -->
<div class="modal" id="taskModal">
  <div class="box">
    <div style="font-weight:900;margin-bottom:6px;">タスク名を入力</div>
    <div class="row"><input class="input" id="taskName" placeholder="例：水筒"></div>
    <div class="row">
      <button class="ok" id="taskOk" type="button">保存</button>
      <button class="close" id="taskCancel" type="button">キャンセル</button>
    </div>
  </div>
</div>

<!-- アラーム -->
<div class="alarm" id="alarm">
  <div class="panel">
    <div class="msg" id="alarmMsg">10分前</div>
    <div class="sub">出発の準備は大丈夫？</div>
    <button class="ok" id="alarmOK" type="button">OK</button>
  </div>
</div>

<script>
(() => {
  // ===== DOM =====
  const grid = document.getElementById('grid');
  const linesLayer = document.getElementById('linesLayer');
  const timeLabels = document.getElementById('timeLabels');
  const timeScroll = document.getElementById('timeScroll');
  const timeSpacer = document.getElementById('timeSpacer');
  const departLine = document.getElementById('departLine');
  const departHandle = document.getElementById('departHandle');
  const nowLine = document.getElementById('nowLine');
  const placeEl = document.getElementById('place');

  const resetBtn = document.getElementById('resetBtn');
  const shareBtn = document.getElementById('shareBtn');
  const tagsWrap = document.getElementById('tags');
  const addTaskBtn = document.getElementById('addTaskBtn');

  const toastEl = document.getElementById('toast');
  const countdownEl = document.getElementById('countdown');

  const depModal = document.getElementById('depModal');
  const openDepart = document.getElementById('openDepart');
  const departInput = document.getElementById('departInput');
  const depOk = document.getElementById('depOk');
  const depCancel = document.getElementById('depCancel');
  const departText = document.getElementById('departText');

  const taskModal = document.getElementById('taskModal');
  const taskName = document.getElementById('taskName');
  const taskOk = document.getElementById('taskOk');
  const taskCancel = document.getElementById('taskCancel');

  const alarmEl = document.getElementById('alarm');
  const alarmMsgEl = document.getElementById('alarmMsg');
  const alarmOK = document.getElementById('alarmOK');

  // ===== Emoji Map =====
  const EMOJI = { "トイレ":"🚽","化粧":"💄","着替え":"👕","持ち物":"👜","食器片付け":"🍽️","ゴミ捨て":"🗑️" };
  const iconOf = (name) => EMOJI[name] || "📌";
  const withIcon = (name) => `${iconOf(name)} ${name}`;

  // ===== State =====
  const LS_KEYS = ['tripshare_v8','tripshare_v7'];
  let state = {
    place: "",
    departAt: NaN,                // 未設定
    slot: 10,
    tasksPalette: ["着替え","トイレ","持ち物","食器片付け","ゴミ捨て","化粧"],
    events: [], // {id, memberIndex, title, start, end}
  };
  const CARD_COLORS = ['#3b82f6','#ef476f','#06d6a0','#ffa600'];

  // 左の時刻スクロール量
  let scrollY = 0;

  // ===== Audio for alarm =====
  let audioCtx=null, beepOsc=null, beepGain=null, alarmTimer=null;
  function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } if(audioCtx.state==='suspended') audioCtx.resume(); }
  function startBeep(){
    try{
      ensureAudio(); stopBeep();
      beepOsc = audioCtx.createOscillator(); beepGain = audioCtx.createGain();
      beepOsc.type='sine'; beepOsc.frequency.value=880;
      beepOsc.connect(beepGain); beepGain.connect(audioCtx.destination);
      beepGain.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      for(let i=0;i<60;i++){ const t=audioCtx.currentTime+i*0.5; beepGain.gain.setValueAtTime(0.001,t); beepGain.gain.exponentialRampToValueAtTime(0.08,t+0.1); beepGain.gain.exponentialRampToValueAtTime(0.001,t+0.5); }
      beepOsc.start();
    }catch(e){}
  }
  function stopBeep(){ if(beepOsc){try{beepOsc.stop();}catch{} beepOsc.disconnect(); beepOsc=null;} if(beepGain){try{beepGain.disconnect();}catch{} beepGain=null;} if(alarmTimer){clearTimeout(alarmTimer); alarmTimer=null;} }

  // ===== Helpers =====
  function showToast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1600); }
  function pad(n){return (n<10?'0':'')+n}
  function fmtHM(d){ return pad(d.getHours())+":"+pad(d.getMinutes()) }
  function parseHM(hm, base){ const [h,m]=hm.split(':').map(Number); const d=new Date(base||Date.now()); d.setHours(h,m||0,0,0); return +d; }
  function roundTo10Min(ms){ const d=new Date(ms); const r=Math.round(d.getMinutes()/10)*10; d.setMinutes(r,0,0); return +d; }
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }
  function pxPerMin(){ return Number(getComputedStyle(document.documentElement).getPropertyValue('--px-per-min')); }
  // 表示窓：出発 -2h ～ +0.5h（150分）
  function getWindow(){
    const dep = isNaN(state.departAt) ? new Date() : new Date(state.departAt);
    const start=new Date(+dep - 120*60*1000);
    const end  =new Date(+dep +  30*60*1000);
    return {start,end,durationMs:(+end - +start)};
  }

  // ===== Load/Save =====
  function load(){ for(const key of LS_KEYS){ const s=localStorage.getItem(key); if(s){ try{ state=JSON.parse(s); break; }catch(e){} } } }
  function save(){ localStorage.setItem(LS_KEYS[0], JSON.stringify(state)); }

  // ===== Palette =====
  function rebuildTags(){
    tagsWrap.innerHTML="";
    state.tasksPalette.forEach(name=>{
      const t=document.createElement('div');
      t.className='tag';
      t.textContent = withIcon(name); // パレット＝アイコン＋文字
      tagsWrap.appendChild(t);

      let pressTimer=null, dragging=false, startX=0, startY=0, pid=null, ghost=null;
      const clearTimer=()=>{ if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; } };
      const startLongPress=(x,y)=>{
        startX=x; startY=y; clearTimer();
        pressTimer=setTimeout(()=>{
          if(!dragging && confirm(`「${name}」をパレットから削除しますか？`)){
            state.tasksPalette=state.tasksPalette.filter(x=>x!==name);
            rebuildTags(); save();
          }
        }, 600);
      };
      const moved=(x,y)=> Math.hypot(x-startX, y-startY) > 8;

      const onDown=(e)=>{ pid=e.pointerId; dragging=false; ghost=null; startLongPress(e.clientX,e.clientY); t.setPointerCapture(pid); };
      const onMove=(e)=>{ if(pid!==e.pointerId) return;
        if(moved(e.clientX,e.clientY) && !dragging){ clearTimer(); dragging=true; ghost=startGhostDrag(name); }
        if(dragging && ghost){ e.preventDefault(); ghost.move(e.clientX,e.clientY); }
      };
      const onUp=(e)=>{ if(pid!==e.pointerId) return; clearTimer();
        if(dragging && ghost){ ghost.up(e.clientX,e.clientY); }
        dragging=false; ghost=null; pid=null; t.releasePointerCapture(e.pointerId);
      };
      const onCancel=()=>{ clearTimer(); if(ghost){ ghost.cancel(); ghost=null; } dragging=false; pid=null; };

      t.addEventListener('pointerdown', onDown);
      t.addEventListener('pointermove', onMove, {passive:false});
      t.addEventListener('pointerup', onUp);
      t.addEventListener('pointercancel', onCancel);
    });
  }

  // 追加モーダル
  addTaskBtn.addEventListener('click', ()=>{
    taskName.value="";
    taskModal.style.display='flex';
    setTimeout(()=>taskName.focus(), 50);
  });
  taskCancel.addEventListener('click', ()=> taskModal.style.display='none');
  taskOk.addEventListener('click', ()=>{
    const v=taskName.value.trim(); if(!v) return;
    if(!state.tasksPalette.includes(v)){ state.tasksPalette.push(v); save(); rebuildTags(); showToast("タスクを追加しました"); }
    taskModal.style.display='none';
  });

  // ===== D&D ghost from palette =====
  function startGhostDrag(title){
    const ghost=document.createElement('div');
    ghost.className='card ghost';
    ghost.style.top='-1000px';
    ghost.style.height=(pxPerMin()*state.slot)+'px';
    ghost.style.background = 'rgba(0,0,0,.25)';
    ghost.innerHTML = `<span class="icon">${iconOf(title)}</span>`;
    grid.appendChild(ghost);

    let overColIndex=-1;

    const move=(clientX, clientY)=>{
      const rect=grid.getBoundingClientRect();
      ghost.style.left = (clientX - rect.left - 20) + 'px';
      ghost.style.top  = (clientY - rect.top  - 24 + scrollY) + 'px'; // 見た目同期
      overColIndex=-1;
      document.querySelectorAll('.memberCol').forEach((col,idx)=>{
        const r=col.getBoundingClientRect();
        if(clientX>r.left && clientX<r.right && clientY>r.top && clientY<r.bottom){ overColIndex=idx; }
      });
    };

    const finalize=(clientX, clientY)=>{
      ghost.remove();
      if(overColIndex===-1) return;
      const col = memberCol(overColIndex);
      const r=col.getBoundingClientRect();
      const y = clamp(clientY - r.top + scrollY, 0, r.height + scrollY);
      const slotPx = state.slot * pxPerMin();
      const ny = Math.round(y/slotPx)*slotPx;
      const start = +getWindow().start + (ny/pxPerMin())*60000;
      const end   = start + state.slot*60000;
      const id = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()+Math.random());
      const ev = { id, memberIndex:overColIndex, title:title, start, end };
      state.events.push(ev); save(); addCard(ev);
    };

    const cancel=()=>{ ghost.remove(); };

    return { move, up:finalize, cancel };
  }

  // ===== Grid / Lines / Labels =====
  function rebuildGrid(){
    const win=getWindow();
    const durMin = (win.durationMs/60000)|0;
    const height = durMin * pxPerMin();
    grid.style.height = height + "px";
    timeSpacer.style.height = height + "px";

    // ライン＆ラベル再生成
    linesLayer.innerHTML=""; timeLabels.innerHTML="";
    for(let m=0; m<=durMin; m+=10){
      const y = m*pxPerMin();
      const abs = new Date(+win.start + m*60000);
      const line=document.createElement('div');
      line.className='rowLine' + ((abs.getMinutes()%30===0)?' major':'');
      line.style.top = y + "px";
      linesLayer.appendChild(line);

      if(abs.getMinutes()===0){
        const lab=document.createElement('div');
        lab.className='timeLabel';
        lab.style.top = y + "px";
        lab.textContent = `${pad(abs.getHours())}:00`;
        timeLabels.appendChild(lab);
      }
    }

    placeDepartLine(); placeNowLine();

    // カード再描画
    document.querySelectorAll('.colBody').forEach(col=> col.innerHTML="");
    state.events.forEach(ev=> addCard(ev));

    // 現在のスクロール位置反映
    applyScroll();
  }

  function placeDepartLine(){
    const win=getWindow();
    const y = ((+new Date(state.departAt||Date.now()) - +win.start)/60000) * pxPerMin();
    departLine.style.top = (y - scrollY) + "px";
    departHandle.style.top = (y - 26 - scrollY) + "px";
    departHandle.textContent = "出発 " + (isNaN(state.departAt) ? "--:--" : fmtHM(new Date(state.departAt)));
  }
  function placeNowLine(){
    const win=getWindow();
    const now=new Date();
    const y = clamp(((+now - +win.start)/60000) * pxPerMin(), -1000, (+win.end - +win.start)/60000 * pxPerMin());
    nowLine.style.top = (y - scrollY) + "px";
  }
  setInterval(placeNowLine, 60000);

  function memberCol(index){ return document.querySelectorAll('.memberCol')[index]; }
  function colBody(index){ return memberCol(index).querySelector('.colBody'); }

  // 左の時刻スクロール → 同期
  timeScroll.addEventListener('scroll', ()=>{
    scrollY = timeScroll.scrollTop;
    applyScroll();
  });
  function applyScroll(){
    document.querySelectorAll('.colBody').forEach(el=>{
      el.style.transform = `translateY(${-scrollY}px)`;
    });
    linesLayer.style.transform = `translateY(${-scrollY}px)`;
    timeLabels.style.transform = `translateY(${-scrollY}px)`;
    placeDepartLine(); placeNowLine();
  }

  // ===== Card =====
  function addCard(ev){
    const cb = colBody(ev.memberIndex);
    const win=getWindow();
    const y0 = ((ev.start - +win.start)/60000) * pxPerMin();
    const h  = ((ev.end   - ev.start)/60000) * pxPerMin();

    const card=document.createElement('div');
    card.className='card';
    card.style.top = y0 + "px";
    card.style.height = Math.max(h, pxPerMin()*10) + "px";
    card.style.background = (['#3b82f6','#ef476f','#06d6a0','#ffa600'][ev.memberIndex] || '#3b82f6');
    card.dataset.id = ev.id; card.dataset.member = ev.memberIndex;
    card.innerHTML = `<span class="icon">${iconOf(ev.title)}</span><div class="resize"></div><button class="delBtn" title="削除">削除</button>`;

    let pid=null, startY=null, origTop=null, resizing=false, resizeMode=false, origHeight=null;
    let startX=null, swiped=false;
    const slotPx = state.slot * pxPerMin();

    const enterResizeMode = ()=>{ resizeMode=true; card.classList.add('dragging'); if(navigator.vibrate) navigator.vibrate(10); };
    const leaveResizeMode = ()=>{ resizeMode=false; card.classList.remove('dragging'); };

    let holdTimer=null;
    const startHold=(x)=>{ clearTimeout(holdTimer); holdTimer=setTimeout(()=>enterResizeMode(), 600); startX=x; };
    const cancelHold=()=>{ clearTimeout(holdTimer); };

    const onDown=(e)=>{
      e.preventDefault();
      card.setPointerCapture(e.pointerId);
      pid=e.pointerId; startY=e.clientY + scrollY;
      origTop=parseFloat(card.style.top); origHeight=parseFloat(card.style.height);
      resizing = e.target.classList.contains('resize');
      startHold(e.clientX);
    };
    const onMove=(e)=>{
      if(pid!==e.pointerId) return;
      const dx = e.clientX - startX;
      const dy = (e.clientY + scrollY) - startY;

      if(!resizeMode && Math.abs(dx) > 22 && Math.abs(dy) < 16){
        cancelHold();
        swiped = dx < -22;
        card.classList.toggle('swipeLeft', swiped);
      }

      if(resizeMode || resizing){
        cancelHold();
        let nh = origHeight + dy;
        nh = Math.max(slotPx, Math.round(nh/slotPx)*slotPx);
        card.style.height = nh + "px";
      }else if(!swiped){
        let ny=origTop + dy;
        ny = Math.round(ny/slotPx)*slotPx;
        card.style.top = ny + "px";
      }
    };
    const onUp=(e)=>{
      if(pid!==e.pointerId) return;
      cancelHold(); card.releasePointerCapture(e.pointerId); card.classList.remove('dragging');

      const ny=parseFloat(card.style.top);
      const nh=parseFloat(card.style.height);
      const startMs = +getWindow().start + (ny/pxPerMin())*60000;
      const endMs   = startMs + (nh/pxPerMin())*60000;
      const s = state.events.find(x=>x.id===ev.id);
      if(s){ s.start=startMs; s.end=endMs; save(); }
      pid=null; resizing=false; leaveResizeMode();
    };
    const onCancel=()=>{ cancelHold(); card.releasePointerCapture?.(pid); pid=null; leaveResizeMode(); };

    card.querySelector('.delBtn').addEventListener('click', (e)=>{
      e.stopPropagation();
      if(confirm('このカードを削除しますか？')){
        state.events = state.events.filter(x=>x.id!==ev.id);
        card.remove(); save();
      }else{
        card.classList.remove('swipeLeft');
      }
    });

    card.addEventListener('pointerdown', onDown, {passive:false});
    card.addEventListener('pointermove', onMove, {passive:false});
    card.addEventListener('pointerup', onUp);
    card.addEventListener('pointercancel', onCancel);

    cb.appendChild(card);
  }

  // ===== Depart handle（10分スナップ） =====
  (()=> {
    let pid=null, startY=null, startTop=null;
    const down=(e)=>{ e.preventDefault(); departHandle.setPointerCapture(e.pointerId); pid=e.pointerId; startY=e.clientY+scrollY; startTop=parseFloat(departHandle.style.top)||0; };
    const move=(e)=>{
      if(pid!==e.pointerId) return;
      const dy=(e.clientY+scrollY)-startY;
      const slotPx = state.slot * pxPerMin();
      const ny=Math.round((startTop+dy)/slotPx)*slotPx;
      departHandle.style.top = ny+"px";
      departLine.style.top = (ny+26)+"px";
    };
    const up=(e)=>{
      if(pid!==e.pointerId) return;
      departHandle.releasePointerCapture(e.pointerId);
      pid=null;
      const win=getWindow();
      const y=parseFloat(departLine.style.top);
      let newDep = +win.start + (y/pxPerMin())*60000;
      newDep = roundTo10Min(newDep);
      if (newDep !== state.departAt){
        if(confirm("時間変更を通知しますか？")){
          state.departAt = newDep; save();
          rebuildGrid(); updateDepartUI(); resetAlarms();
          showToast("出発時間を更新しました");
        }else{
          rebuildGrid();
        }
      }
    };
    departHandle.addEventListener('pointerdown', down);
    departHandle.addEventListener('pointermove', move);
    departHandle.addEventListener('pointerup', up);
  })();

  // ===== Header buttons =====
  resetBtn.addEventListener('click', ()=>{
    if(confirm('すべてリセットしますか？（出発時刻も未設定に戻ります）')){
      state.events=[]; state.departAt=NaN; state.place=""; save();
      placeEl.value=""; updateDepartUI(); rebuildGrid();
    }
  });
  shareBtn.addEventListener('click', ()=>{
    const data = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(state)))));
    const url = location.origin+location.pathname+'?state='+data;
    navigator.clipboard.writeText(url).then(()=> showToast("共有リンクをコピーしました"));
  });

  // ===== Depart modal（1回タップで開く） =====
  openDepart.addEventListener('click', (e)=>{
    e.preventDefault();
    departInput.value = isNaN(state.departAt) ? "" : fmtHM(new Date(state.departAt));
    depModal.style.display='flex';
    setTimeout(()=>departInput.focus(), 30);
  }, {passive:false});
  depCancel.addEventListener('click', ()=> depModal.style.display='none');
  depOk.addEventListener('click', ()=>{
    const base = isNaN(state.departAt) ? Date.now() : state.departAt;
    const next = roundTo10Min(departInput.value ? parseHM(departInput.value, base) : base);
    state.departAt = next; state.place = placeEl.value.trim(); save();
    depModal.style.display='none';
    rebuildGrid(); updateDepartUI(); resetAlarms();
    try{ ensureAudio(); }catch{}
    showToast("保存しました");
  });

  // ===== UI helpers =====
  function updateDepartUI(){
    if(isNaN(state.departAt)){
      departText.textContent = "設定";
      departText.className = "departUnset";
    }else{
      departText.textContent = fmtHM(new Date(state.departAt));
      departText.className = "departSet";
    }
  }

  // ===== Countdown & Alarms =====
  const ALARM_MINUTES = [30,20,10,5];
  let fired = {};
  function resetAlarms(){ fired={}; updateCountdown(); }
  function updateCountdown(){
    if(isNaN(state.departAt)){ countdownEl.textContent='残り --:--'; return; }
    const now = new Date();
    const diff = state.departAt - +now;
    const s = Math.max(0, Math.floor(diff/1000));
    const mm = Math.floor(s/60), ss = s%60;
    countdownEl.textContent = `残り ${pad(mm)}:${pad(ss)}`;
    const mins = Math.ceil(diff/60000);
    if(ALARM_MINUTES.includes(mins) && !fired[mins]){
      fired[mins]=true; triggerAlarm(mins);
    }
  }
  setInterval(updateCountdown, 1000);

  function triggerAlarm(mins){
    alarmMsgEl.textContent = `${mins}分前`;
    alarmEl.style.display='flex';
    if(navigator.vibrate) navigator.vibrate([80,120,80,200,120,80]);
    startBeep();
    alarmTimer = setTimeout(()=>{ stopBeep(); }, 30000);
  }
  alarmOK.addEventListener('click', ()=>{
    alarmEl.style.display='none';
    stopBeep();
  });

  // ===== Import via URL =====
  (function importFromQuery(){
    const p=new URLSearchParams(location.search).get('state');
    if(p){
      try{
        const obj=JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(p)))));
        state=obj; save(); history.replaceState({},"",location.pathname);
      }catch(e){}
    }
  })();

  // ===== Init =====
  function init(){
    load();
    updateDepartUI();
    rebuildTags();
    rebuildGrid();
    updateCountdown();
  }
  init();
})();
</script>
</body>
</html>
