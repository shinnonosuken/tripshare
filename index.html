<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>出発時間の共有</title>
<meta name="theme-color" content="#0f172a" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<link rel="apple-touch-icon" href="#" id="appleIcon">
<style>
  :root{
    --bg:#0b1220;       /* 背景(濃紺) */
    --card:#111827;     /* カード(グレー) */
    --muted:#94a3b8;    /* テキスト副 */
    --fg:#e5e7eb;       /* テキスト主 */
    --acc:#22d3ee;      /* アクセント */
    --ok:#22c55e;       /* 成功 */
    --warn:#f59e0b;     /* 注意 */
    --bad:#ef4444;      /* 却下 */
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --radius: 16px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0b1220, #0c1322 40%, #0b1220 100%);
    color:var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic UI", "Noto Sans JP", sans-serif;
  }
  .app{max-width:840px; margin:0 auto; padding: env(safe-area-inset-top) 16px calc(24px + env(safe-area-inset-bottom));}
  header{
    position:sticky; top:0; z-index:3; backdrop-filter:saturate(140%) blur(10px);
    background:rgba(11,18,32,.7); border-bottom:1px solid rgba(255,255,255,.06);
  }
  .topbar{display:flex; align-items:center; gap:10px; padding:12px 12px;}
  .title{font-weight:800; letter-spacing:.02em; font-size:18px}
  .spacer{flex:1}
  button{appearance:none; border:none; background:var(--acc); color:#001014; font-weight:700; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); cursor:pointer}
  button.ghost{background:transparent; color:var(--fg); box-shadow:none; border:1px solid rgba(255,255,255,.12)}
  button.warn{background:var(--warn); color:#1d1000}
  button.ok{background:var(--ok); color:#001402}
  button.bad{background:var(--bad); color:#2b0000}
  .row{display:flex; gap:12px; flex-wrap:wrap}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); padding:14px; box-shadow:var(--shadow)}
  .section-title{font-size:14px; color:var(--muted); margin:4px 0 10px}
  .trip{display:grid; grid-template-columns: 1fr; gap:10px}
  .trip .field{display:grid; grid-template-columns: 96px 1fr; gap:10px; align-items:center}
  input, select, textarea{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.02); color:var(--fg); outline:none
  }
  input[type="time"]{letter-spacing:.04em}
  .members{display:grid; grid-template-columns:1fr; gap:12px}
  @media(min-width:680px){ .members{grid-template-columns:1fr 1fr} }
  .member-card{display:grid; gap:8px}
  .member-head{display:flex; align-items:center; gap:10px}
  .avatar{width:36px; height:36px; border-radius:50%; display:grid; place-items:center; font-weight:900; color:#001014}
  .progress{height:8px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
  .progress > i{display:block; height:100%; background:var(--acc); width:0%}
  .tasks{display:grid; gap:8px}
  .task{display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.03); border:1px dashed rgba(255,255,255,.08)}
  .task input{width:auto}
  .muted{color:var(--muted)}
  .pill{padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); font-size:12px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .toast{position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:10; background:#0b1220; border:1px solid rgba(255,255,255,.12); padding:12px 14px; border-radius:12px; box-shadow:var(--shadow)}
  .banner{position:sticky; top:56px; z-index:2; margin:10px 0; padding:10px 12px; border-radius:12px; background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.45);}
  .footer{margin:18px 0 0; font-size:12px; color:var(--muted)}
  dialog{border:none; border-radius:16px; padding:0; background:#0f172a; color:var(--fg); box-shadow:var(--shadow); width:min(720px, 92vw)}
  .sheet{padding:16px}
  .sheet h3{margin:0 0 10px}
  .sheet .actions{display:flex; gap:8px; justify-content:flex-end; padding:10px 16px 16px}
  .kpi{display:flex; gap:10px; flex-wrap:wrap}
  .kpi .box{background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:12px}
  .link{color:var(--acc); text-decoration:underline; cursor:pointer}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="title">出発時間の共有</div>
    <span class="pill" id="installHint" hidden>ホーム画面に追加可</span>
    <div class="spacer"></div>
    <button class="ghost" id="shareBtn" title="共有">共有</button>
    <button id="editTripBtn" title="設定">設定</button>
  </div>
</header>
<div class="app">
  <div id="changeBanner" class="banner" hidden></div>

  <section class="card">
    <div class="section-title">おでかけ情報</div>
    <div class="trip" id="tripInfo">
      <div class="field"><div class="muted">行く場所</div><div id="placeView">—</div></div>
      <div class="field"><div class="muted">目的</div><div id="purposeView">—</div></div>
      <div class="field"><div class="muted">出発時間</div><div><span id="timeView">—</span> <span class="pill" id="etaLeft">—</span></div></div>
    </div>
    <div class="kpi" style="margin-top:10px">
      <div class="box">全体進捗：<b id="overallPct">0%</b></div>
      <div class="box">メンバー：<b id="memberCount">0</b>/4</div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button class="warn" id="requestChangeBtn">時間変更を提案</button>
      <button class="ghost" id="notifyBtn">通知テスト</button>
      <button class="ghost" id="addToHomeBtn" hidden>ホーム画面に追加</button>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="section-title">メンバーの準備状況（最大4人）</div>
    <div class="members" id="members"></div>
    <div class="toolbar" style="margin-top:10px">
      <button class="ghost" id="addMemberBtn">＋ メンバー追加</button>
      <button class="ghost" id="editTasksBtn">チェック項目を編集</button>
    </div>
  </section>

  <div class="footer">保存はこの端末のローカル（オフライン可）。家族に共有するには右上「共有」からリンクを送ってください（読み込み時点の内容を含みます）。</div>
</div>

<!-- ダイアログ: おでかけ設定 -->
<dialog id="tripDialog">
  <form method="dialog" class="sheet">
    <h3>おでかけ設定</h3>
    <div class="trip">
      <div class="field"><label class="muted">行く場所</label><input id="placeInput" placeholder="例：〇〇公園"></div>
      <div class="field"><label class="muted">目的</label><input id="purposeInput" placeholder="例：ピクニック"></div>
      <div class="field"><label class="muted">出発時間</label><input id="timeInput" type="time"></div>
    </div>
    <div class="actions">
      <button class="ghost" value="cancel">キャンセル</button>
      <button value="ok">保存</button>
    </div>
  </form>
</dialog>

<!-- ダイアログ: 時間変更提案 -->
<dialog id="changeDialog">
  <form method="dialog" class="sheet">
    <h3>時間変更を提案</h3>
    <div class="trip">
      <div class="field"><label class="muted">現在の出発</label><input id="currentTime" disabled></div>
      <div class="field"><label class="muted">提案する時間</label><input id="proposedTime" type="time"></div>
      <div class="field"><label class="muted">理由（任意）</label><input id="proposedReason" placeholder="例：子どもの準備が押しそう" ></div>
    </div>
    <div class="actions">
      <button class="ghost" value="cancel">キャンセル</button>
      <button class="warn" value="ok">提案を送る</button>
    </div>
  </form>
</dialog>

<!-- ダイアログ: メンバー編集/追加 -->
<dialog id="memberDialog">
  <form method="dialog" class="sheet">
    <h3>メンバー</h3>
    <div class="trip">
      <div class="field"><label class="muted">名前</label><input id="memberName"></div>
      <div class="field"><label class="muted">カラー</label>
        <select id="memberColor">
          <option value="#22d3ee">アクア</option>
          <option value="#60a5fa">ブルー</option>
          <option value="#34d399">グリーン</option>
          <option value="#f472b6">ピンク</option>
          <option value="#f59e0b">オレンジ</option>
          <option value="#a78bfa">パープル</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="ghost" value="cancel">やめる</button>
      <button value="ok">保存</button>
    </div>
  </form>
</dialog>

<!-- ダイアログ: タスク編集（共通テンプレ） -->
<dialog id="tasksDialog">
  <form method="dialog" class="sheet">
    <h3>チェック項目（全メンバー共通）</h3>
    <div class="section-title">1行につき1項目。空行は無視。</div>
    <textarea id="tasksText" rows="8" style="width:100%"></textarea>
    <div class="actions">
      <button class="ghost" value="cancel">キャンセル</button>
      <button value="ok">反映</button>
    </div>
  </form>
</dialog>

<div id="toast" class="toast" hidden>通知</div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const state = loadState();
  const MAX_MEMBERS = 4;

  // --- UI refs ---
  const placeView = $('#placeView');
  const purposeView = $('#purposeView');
  const timeView = $('#timeView');
  const etaLeft = $('#etaLeft');
  const membersEl = $('#members');
  const memberCount = $('#memberCount');
  const overallPct = $('#overallPct');
  const changeBanner = $('#changeBanner');
  const toast = $('#toast');

  // --- Event bindings ---
  $('#editTripBtn').addEventListener('click', openTripDialog);
  $('#requestChangeBtn').addEventListener('click', openChangeDialog);
  $('#notifyBtn').addEventListener('click', () => notify('テスト通知', '通知の動作を確認しました。'));
  $('#addMemberBtn').addEventListener('click', () => openMemberDialog());
  $('#editTasksBtn').addEventListener('click', openTasksDialog);
  $('#shareBtn').addEventListener('click', shareLink);

  // iOSホーム追加ヒント
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(!isStandalone) $('#installHint').hidden = false;

  // Load
  renderAll();
  tickETA();
  setInterval(tickETA, 1000 * 30);

  // --- State ---
  function loadState(){
    try{
      // URLにstate=がある場合は読み込んで保存
      const u = new URL(location.href);
      const encoded = u.searchParams.get('state');
      if(encoded){
        const json = atob(decodeURIComponent(encoded));
        const obj = JSON.parse(json);
        localStorage.setItem('tripshare_state', JSON.stringify(obj));
        // クエリを掃除
        u.searchParams.delete('state'); history.replaceState(null, '', u.toString());
      }
    }catch(e){ console.warn('state import failed', e); }
    const defaultTasks = ['着替え', '荷物チェック', 'トイレ', '水筒/飲み物', '施錠・電気確認'];
    const saved = JSON.parse(localStorage.getItem('tripshare_state') || 'null');
    return saved || {
      trip: { place:'', purpose:'', time:'' },
      tasks: defaultTasks,
      members: [] ,
      change: null // {proposedTime, reason, approvals:[], rejections:[]}
    };
  }
  function save(){ localStorage.setItem('tripshare_state', JSON.stringify(state)); }

  // --- Render ---
  function renderAll(){
    placeView.textContent = state.trip.place || '—';
    purposeView.textContent = state.trip.purpose || '—';
    timeView.textContent = state.trip.time || '—';

    // Members
    membersEl.innerHTML = '';
    state.members.forEach((m, idx) => membersEl.appendChild(renderMember(m, idx)) );
    memberCount.textContent = state.members.length;

    // Overall progress
    const all = state.members.flatMap(m => m.tasks);
    const pct = all.length ? Math.round(all.filter(t=>t.done).length / all.length * 100) : 0;
    overallPct.textContent = pct + '%';

    renderBanner();
  }

  function renderMember(m, idx){
    const card = document.createElement('div');
    card.className = 'member-card card';
    const initials = (m.name || '—').slice(0,2);
    card.innerHTML = `
      <div class="member-head">
        <div class="avatar" style="background:${m.color}">${initials}</div>
        <input class="name-input" value="${m.name}" placeholder="メンバー名" />
        <div class="spacer"></div>
        <button class="ghost small" data-act="edit" title="編集">編集</button>
        <button class="ghost small" data-act="del" title="削除">削除</button>
      </div>
      <div class="progress"><i style="width:${memberPct(m)}%"></i></div>
      <div class="tasks">
        ${state.tasks.map((t,i)=>{
          const own = m.tasks[i] || {label:t, done:false};
          const checked = own.done ? 'checked' : '';
          return `<label class="task"><input type="checkbox" data-task="${i}" ${checked}> ${t}</label>`;
        }).join('')}
      </div>
      <div class="toolbar">
        <button class="ghost small" data-act="reset">未完了に戻す</button>
      </div>
    `;
    // Bindings
    card.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', e =>{
        const i = Number(e.target.getAttribute('data-task'));
        m.tasks[i] = {label: state.tasks[i], done: e.target.checked};
        save(); renderAll();
      })
    });
    card.querySelector('.name-input').addEventListener('change', e=>{ m.name = e.target.value.trim(); save(); renderAll(); });
    card.querySelector('[data-act="edit"]').addEventListener('click', ()=> openMemberDialog(m));
    card.querySelector('[data-act="del"]').addEventListener('click', ()=>{ if(confirm('このメンバーを削除しますか？')){ state.members.splice(idx,1); save(); renderAll(); }});
    card.querySelector('[data-act="reset"]').addEventListener('click', ()=>{ m.tasks = state.tasks.map(t=>({label:t, done:false})); save(); renderAll();});
    return card;
  }
  function memberPct(m){
    const done = m.tasks.filter(t=>t.done).length; const total = m.tasks.length || state.tasks.length || 1; return Math.round(done/total*100);
  }

  function renderBanner(){
    const c = state.change; if(!c){ changeBanner.hidden = true; return; }
    const approvals = c.approvals?.length || 0; const rejections = c.rejections?.length || 0;
    changeBanner.hidden = false;
    changeBanner.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap">
        <b>出発時間の変更提案</b> → <span class="pill">${state.trip.time || '—'} ▶ ${c.proposedTime}</span>
        ${c.reason ? `<span class="pill">理由：${escapeHtml(c.reason)}</span>`:''}
        <span class="spacer"></span>
        <span class="muted">賛成 ${approvals}・反対 ${rejections}</span>
        <button class="ok" id="approveBtn">賛成</button>
        <button class="bad" id="rejectBtn">反対</button>
        <button class="ghost" id="dismissBtn">提案を取り下げ</button>
      </div>
    `;
    $('#approveBtn').onclick = ()=> vote(true);
    $('#rejectBtn').onclick = ()=> vote(false);
    $('#dismissBtn').onclick = ()=> { if(confirm('取り下げますか？')){ state.change = null; save(); renderAll(); } };
  }

  // --- Dialogs ---
  function openTripDialog(){
    $('#placeInput').value = state.trip.place || '';
    $('#purposeInput').value = state.trip.purpose || '';
    $('#timeInput').value = state.trip.time || '';
    $('#tripDialog').showModal();
    $('#tripDialog').addEventListener('close', e=>{
      if($('#tripDialog').returnValue === 'ok'){
        state.trip.place = $('#placeInput').value.trim();
        state.trip.purpose = $('#purposeInput').value.trim();
        state.trip.time = $('#timeInput').value;
        save(); renderAll();
      }
    }, {once:true});
  }

  function openChangeDialog(){
    if(!state.trip.time){ toastMsg('まず出発時間を設定してください'); return; }
    $('#currentTime').value = state.trip.time;
    $('#proposedTime').value = state.trip.time;
    $('#proposedReason').value = '';
    $('#changeDialog').showModal();
    $('#changeDialog').addEventListener('close', e=>{
      if($('#changeDialog').returnValue === 'ok'){
        const t = $('#proposedTime').value; if(!t || t===state.trip.time){ toastMsg('別の時間を選んでください'); return; }
        state.change = { proposedTime: t, reason: $('#proposedReason').value.trim(), approvals:[], rejections:[] };
        save(); renderAll();
        notify('出発時間の変更提案', `${formatTime(state.trip.time)} → ${formatTime(t)}${state.change.reason? '｜'+state.change.reason: ''}`);
        vibrate();
      }
    }, {once:true});
  }

  function openMemberDialog(existing){
    const isEdit = !!existing;
    $('#memberName').value = existing?.name || '';
    $('#memberColor').value = existing?.color || '#22d3ee';
    $('#memberDialog').showModal();
    $('#memberDialog').addEventListener('close', e=>{
      if($('#memberDialog').returnValue === 'ok'){
        const name = $('#memberName').value.trim() || 'メンバー';
        const color = $('#memberColor').value;
        if(isEdit){ existing.name = name; existing.color = color; }
        else{
          if(state.members.length >= MAX_MEMBERS){ toastMsg('メンバーは最大4人まで'); return; }
          state.members.push({name, color, tasks: state.tasks.map(t=>({label:t, done:false}))});
        }
        save(); renderAll();
      }
    }, {once:true});
  }

  function openTasksDialog(){
    $('#tasksText').value = state.tasks.join('\n');
    $('#tasksDialog').showModal();
    $('#tasksDialog').addEventListener('close', ()=>{
      if($('#tasksDialog').returnValue==='ok'){
        const lines = $('#tasksText').value.split(/\n+/).map(s=>s.trim()).filter(Boolean);
        state.tasks = lines.length? lines : state.tasks;
        // 各メンバーのタスク配列を再構築（既存の完了状態は可能な限り保持）
        state.members.forEach(m=>{
          const map = new Map(m.tasks.map(t=>[t.label, t.done]));
          m.tasks = state.tasks.map(label=>({label, done: map.get(label) || false}));
        });
        save(); renderAll();
      }
    }, {once:true});
  }

  // --- Voting ---
  function vote(approve){
    if(!state.change) return;
    const myId = deviceId();
    const arrA = state.change.approvals; const arrR = state.change.rejections;
    // 同一端末の重複票を削除
    state.change.approvals = arrA.filter(id=>id!==myId);
    state.change.rejections = arrR.filter(id=>id!==myId);
    (approve ? state.change.approvals : state.change.rejections).push(myId);
    save();
    renderAll();
    // 過半数で確定（登録メンバーの半数超）
    const votersNeeded = Math.floor((state.members.length||1)/2)+1;
    if(state.change.approvals.length >= votersNeeded){
      const old = state.trip.time; state.trip.time = state.change.proposedTime; state.change = null; save(); renderAll();
      notify('出発時間が変更されました', `${formatTime(old)} → ${formatTime(state.trip.time)}`);
      vibrate();
    }
  }

  // --- ETA ---
  function tickETA(){
    if(!state.trip.time){ etaLeft.textContent='—'; return; }
    const [hh, mm] = state.trip.time.split(':').map(Number);
    const now = new Date(); const target = new Date();
    target.setHours(hh, mm, 0, 0);
    const diff = Math.round((target - now)/60000); // minutes
    let txt = '';
    if(diff > 0){
      const h = Math.floor(diff/60), m = diff%60; txt = `出発まで ${h? h+ '時間':''}${m}分`; etaLeft.style.background='rgba(34,211,238,.12)';
    }else if(diff === 0){ txt = '出発時刻です'; etaLeft.style.background='rgba(34,197,94,.18)'; }
    else { txt = `予定を${Math.abs(diff)}分過ぎています`; etaLeft.style.background='rgba(239,68,68,.18)'; }
    etaLeft.textContent = txt;
  }

  // --- Share ---
  async function shareLink(){
    try{
      const url = new URL(location.href);
      const encoded = encodeURIComponent(btoa(JSON.stringify(state)));
      url.searchParams.set('state', encoded);
      const link = url.toString();
      if(navigator.share){ await navigator.share({ title:'出発時間の共有', text:'おでかけ計画を共有します', url: link }); }
      else { await navigator.clipboard.writeText(link); toastMsg('共有リンクをクリップボードにコピーしました'); }
    }catch(e){ toastMsg('共有に失敗しました'); console.error(e); }
  }

  // --- Notifications & UX ---
  function toastMsg(msg){ toast.textContent = msg; toast.hidden = false; setTimeout(()=>toast.hidden = true, 2400); }
  function notify(title, body){
    try{
      if('Notification' in window){
        if(Notification.permission === 'granted'){ new Notification(title, { body }); }
        else if(Notification.permission !== 'denied'){
          Notification.requestPermission().then(p=>{ if(p==='granted') new Notification(title, { body }); else toastMsg(title + '：' + body); });
        } else { toastMsg(title + '：' + body); }
      } else { toastMsg(title + '：' + body); }
    }catch{ toastMsg(title + '：' + body); }
  }
  function vibrate(){ if(navigator.vibrate) navigator.vibrate([20,40,20]); }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  // --- PWA minimal (manifest + SW from Blob) ---
  (function setupPWA(){
    try{
      const iconSize = 192;
      const canvas = document.createElement('canvas'); canvas.width = canvas.height = iconSize;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,iconSize,iconSize);
      ctx.fillStyle = '#22d3ee'; ctx.beginPath(); ctx.arc(iconSize/2, iconSize/2, 72, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#0f172a'; ctx.font = 'bold 88px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('Go', iconSize/2, iconSize/2+4);
      canvas.toBlob(blob=>{
        const iconURL = URL.createObjectURL(blob);
        $('#appleIcon').href = iconURL;
        const manifest = {
          name: '出発時間の共有', short_name: '出発共有', start_url: '.', display: 'standalone', background_color:'#0f172a', theme_color:'#0f172a',
          icons: [{src: iconURL, sizes: iconSize+'x'+iconSize, type: 'image/png'}]
        };
        const mBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
        const mURL = URL.createObjectURL(mBlob);
        const link = document.createElement('link'); link.rel='manifest'; link.href = mURL; document.head.appendChild(link);

        // Service Worker（オフラインキャッシュ＆通知の基盤）
        if('serviceWorker' in navigator){
          const swCode = `self.addEventListener('install', e=>{ e.waitUntil(caches.open('tripshare-v1').then(c=>c.addAll(['./']))); self.skipWaiting(); });
            self.addEventListener('activate', e=> self.clients.claim());
            self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request))); });`;
          const swBlob = new Blob([swCode], {type:'text/javascript'});
          const swURL = URL.createObjectURL(swBlob);
          navigator.serviceWorker.register(swURL).catch(()=>{});
        }
      });
    }catch(e){ console.warn('PWA setup skipped', e); }
  })();

  // 初期データ（デモ用に1回だけメンバーを入れる）
  if(!state.__seeded){
    state.members = [
      {name:'ママ', color:'#f472b6', tasks: state.tasks.map(t=>({label:t, done:false}))},
      {name:'パパ', color:'#60a5fa', tasks: state.tasks.map(t=>({label:t, done:false}))}
    ];
    state.__seeded = true; save(); renderAll();
  }

  function formatTime(t){ return t ? t.split(':').slice(0,2).join(':') : '—'; }
  function deviceId(){
    let id = localStorage.getItem('tripshare_device');
    if(!id){ id = 'd'+Math.random().toString(36).slice(2); localStorage.setItem('tripshare_device', id); }
    return id;
  }
})();
</script>
</body>
</html>
