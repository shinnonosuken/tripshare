<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>出発時間の共有</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
:root{
  --bg:#f7f7fb;
  --ink:#222;
  --muted:#6b7280;
  --brand:#ff7043;
  --accent:#2563eb;
  --grid:#e5e7eb;
  --hour:#d1d5db;
  --card:#3b82f6;
  --card-ink:#fff;
  --shadow:0 6px 18px rgba(0,0,0,.08);
  --radius:14px;
  --col-gap:10px;
  --min-per-slot:10;   /* 10分刻み（UIで切替可能にしてもOK） */
  --px-per-min:3;      /* ズーム係数（1分=3px → 3時間=540px） */
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Helvetica Neue",Arial,sans-serif;
  background:var(--bg); color:var(--ink);
}
.app{
  max-width:1100px; margin:0 auto; padding:12px 12px calc(env(safe-area-inset-bottom) + 16px);
}
.header{
  display:grid; grid-template-columns:1fr auto; gap:12px; align-items:center; margin-bottom:10px;
}
.title{
  background:#fff; border-radius:var(--radius); box-shadow:var(--shadow);
  padding:10px 12px; line-height:1.3;
}
.title strong{font-size:20px}
.meta{font-size:13px; color:var(--muted)}
.controls{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
}
.btn{
  appearance:none; border:0; border-radius:10px; padding:10px 12px; font-weight:600; background:#fff;
  box-shadow:var(--shadow); color:var(--ink); font-size:14px;
}
.btn.primary{ background:var(--brand); color:#fff }
.btn.ghost{ background:transparent; border:1px solid var(--grid) }
.input{
  background:#fff; box-shadow:var(--shadow); border-radius:10px; padding:8px 10px; border:1px solid transparent; font-size:14px;
}
.gridwrap{
  background:#fff; border-radius:var(--radius); box-shadow:var(--shadow);
  padding:10px; position:relative; overflow:hidden;
}
.grid{
  display:grid;
  grid-template-columns: 64px repeat(4, 1fr);
  gap:var(--col-gap);
  height: calc(var(--px-per-min) * 180px); /* ダミー、JSで上書き */
  position:relative;
}
.timeAxis{position:relative}
.timeAxis .tick{position:absolute; left:0; right:0; height:1px; background:var(--grid)}
.timeAxis .hour{background:var(--hour); height:1.5px}
.timeAxis .label{
  position:absolute; left:0; top:-9px; font-size:12px; color:var(--muted);
}
.memberCol{
  position:relative; border-left:1px dashed var(--grid); border-right:1px dashed var(--grid);
  border-radius:8px; background:linear-gradient(to right, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
  overflow:hidden;
}
.memberHead{
  position:sticky; top:0; z-index:3; background:#ffcb05; color:#1f2937; font-weight:700;
  text-align:center; padding:6px 4px; border-radius:6px; margin-bottom:6px; box-shadow:0 2px 8px rgba(0,0,0,.06);
}
.card{
  position:absolute; left:6px; right:6px; min-height: calc(var(--px-per-min) * 10); /* 最短10分 */
  background:var(--card); color:var(--card-ink); border-radius:10px; padding:8px 10px; font-weight:700; font-size:14px;
  box-shadow:0 8px 14px rgba(30,64,175,.25); touch-action:none; user-select:none;
}
.card .sub{font-weight:600; opacity:.9; font-size:11px}
.card .resize{
  position:absolute; left:0; right:0; bottom:-6px; height:12px; cursor:ns-resize;
}
.card.dragging{opacity:.9; outline:2px solid rgba(255,255,255,.6)}
.card.ghost{opacity:.6}
.departLine,.nowLine{
  position:absolute; left:0; right:0; height:2px; z-index:2;
}
.departLine{ background:var(--brand) }
.nowLine{ background:var(--accent) }
.departHandle{
  position:absolute; right:6px; top:-10px; background:var(--brand); color:#fff; padding:6px 10px; border-radius:8px;
  font-weight:800; font-size:13px; box-shadow:var(--shadow); touch-action:none; user-select:none;
}
.palette{
  margin-top:12px; background:#111827; color:#e5e7eb; border-radius:16px; padding:12px; box-shadow:var(--shadow);
}
.palette h3{margin:0 0 8px 0; font-size:14px; letter-spacing:.02em}
.tags{display:flex; flex-wrap:wrap; gap:8px}
.tag{
  background:#3b82f6; color:#fff; padding:8px 10px; border-radius:999px; font-weight:700; font-size:14px;
  box-shadow:0 6px 12px rgba(59,130,246,.3); touch-action:none; user-select:none;
}
.tag:active{transform:scale(.98)}
.tag.del{background:#ef4444}
.addRow{display:flex; gap:8px; margin-top:10px}
.toast{
  position:fixed; left:50%; bottom:calc(12px + env(safe-area-inset-bottom)); transform:translateX(-50%);
  background:#111827; color:#fff; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow); font-weight:700; z-index:50; opacity:0; pointer-events:none; transition:opacity .2s;
}
.toast.show{opacity:1}
.small{font-size:12px; color:var(--muted)}
.tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.tools label{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <div><strong>出発時間の共有</strong></div>
      <div class="meta" id="metaLine">目的地 — 出発 <span id="departText"></span></div>
      <div class="tools">
        <input class="input" id="place" placeholder="行き先（例：イオンモール）" style="min-width:180px">
        <input class="input" id="purpose" placeholder="目的（例：買い物）" style="min-width:160px">
        <input class="input" id="depart" type="time" step="600">
        <button class="btn" id="saveBtn">保存</button>
        <label>刻み
          <select class="input" id="slotSelect">
            <option value="5">5分</option>
            <option value="10" selected>10分</option>
            <option value="15">15分</option>
          </select>
        </label>
      </div>
    </div>
    <div class="controls">
      <button class="btn ghost" id="resetBtn">全削除</button>
      <button class="btn primary" id="shareBtn">共有リンク</button>
    </div>
  </div>

  <div class="gridwrap">
    <div id="grid" class="grid">
      <!-- 左：時間軸 -->
      <div class="timeAxis" id="timeAxis"></div>
      <!-- 右：メンバー列4本 -->
      <div class="memberCol"><div class="memberHead">のすけ</div></div>
      <div class="memberCol"><div class="memberHead">ママ</div></div>
      <div class="memberCol"><div class="memberHead">そう</div></div>
      <div class="memberCol"><div class="memberHead">しゅう</div></div>

      <div class="departLine" id="departLine"></div>
      <div class="nowLine" id="nowLine"></div>
      <div class="departHandle" id="departHandle">出発</div>
    </div>
  </div>

  <div class="palette" id="palette">
    <h3>【タスク】</h3>
    <div class="tags" id="tags"></div>
    <div class="addRow">
      <input class="input" id="newTask" placeholder="タスクを追加（例：化粧）" />
      <button class="btn" id="addTaskBtn">追加</button>
      <span class="small">※ タスクを長押しで削除</span>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
(() => {
  const members = ["のすけ","ママ","そう","しゅう"];
  const grid = document.getElementById('grid');
  const timeAxis = document.getElementById('timeAxis');
  const departLine = document.getElementById('departLine');
  const departHandle = document.getElementById('departHandle');
  const nowLine = document.getElementById('nowLine');
  const placeEl = document.getElementById('place');
  const purposeEl = document.getElementById('purpose');
  const departEl = document.getElementById('depart');
  const departText = document.getElementById('departText');
  const slotSelect = document.getElementById('slotSelect');
  const saveBtn = document.getElementById('saveBtn');
  const resetBtn = document.getElementById('resetBtn');
  const shareBtn = document.getElementById('shareBtn');
  const tagsWrap = document.getElementById('tags');
  const addTaskBtn = document.getElementById('addTaskBtn');
  const newTaskEl = document.getElementById('newTask');
  const toastEl = document.getElementById('toast');

  // ----- State -----
  const LS_KEY = 'tripshare_v2';
  let state = {
    place: "",
    purpose: "",
    departAt: roundToSlot(new Date(), 10).setSeconds(0,0), // 初期=今丸め
    slot: 10, // 5/10/15
    tasksPalette: ["着替え","トイレ","持ち物","食器片付け","ゴミ捨て","化粧"],
    events: [] // {id, memberIndex, title, start:number(ms), end:number(ms)}
  };

  // helpers
  function showToast(msg){ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1600); }
  function pad(n){return (n<10?'0':'')+n}
  function fmtHM(d){ return pad(d.getHours())+":"+pad(d.getMinutes()) }
  function parseHM(hm, baseDate=new Date()){
    const [h,m]=hm.split(':').map(Number); const d=new Date(baseDate);
    d.setHours(h,m||0,0,0); return d;
  }
  function roundToSlot(d, mins){
    const ms=+d; const base=new Date(d); base.setSeconds(0,0);
    const q = Math.round(base.getMinutes()/mins)*mins;
    base.setMinutes(q); return base;
  }
  function clamp(v,min,max){ return Math.max(min, Math.min(max,v)); }

  // window range (dep-2h .. dep+1h)
  function getWindow(){
    const dep=new Date(state.departAt);
    const start=new Date(+dep - 2*60*60*1000);
    const end  =new Date(+dep + 1*60*60*1000);
    return {start,end,durationMs:(+end - +start)};
  }

  function minutesPerPixel(){ return 1/Number(getComputedStyle(document.documentElement).getPropertyValue('--px-per-min')); }
  function pxPerMin(){ return Number(getComputedStyle(document.documentElement).getPropertyValue('--px-per-min')); }

  // ----- Load/Save -----
  function load(){
    const s=localStorage.getItem(LS_KEY);
    if(s){ try{ state=JSON.parse(s); }catch(e){} }
  }
  function save(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  // ----- Build tags (palette) -----
  function rebuildTags(){
    tagsWrap.innerHTML="";
    state.tasksPalette.forEach(name=>{
      const t=document.createElement('div');
      t.className='tag'; t.textContent=name;
      t.addEventListener('touchstart', e=>startDragFromTag(e, name), {passive:false});
      t.addEventListener('mousedown', e=>startDragFromTag(e, name));
      // long press delete
      let pressTimer=null;
      const startPress=()=>{ pressTimer=setTimeout(()=>{ if(confirm(`「${name}」を削除しますか？`)){ state.tasksPalette=state.tasksPalette.filter(x=>x!==name); rebuildTags(); save(); } },600); };
      const cancelPress=()=>{ clearTimeout(pressTimer); };
      t.addEventListener('touchstart', startPress, {passive:true});
      t.addEventListener('touchend', cancelPress);
      t.addEventListener('mousedown', startPress);
      t.addEventListener('mouseup', cancelPress);
      tagsWrap.appendChild(t);
    });
  }

  addTaskBtn.addEventListener('click', ()=>{
    const v=newTaskEl.value.trim(); if(!v) return;
    if(!state.tasksPalette.includes(v)){ state.tasksPalette.push(v); rebuildTags(); save(); }
    newTaskEl.value="";
  });

  // ----- Timeline grid -----
  function rebuildGrid(){
    const win=getWindow();
    const durMin = (win.durationMs/60000)|0; // 180分
    const gridHeight = durMin * pxPerMin();
    grid.style.height = gridHeight + "px";

    // clear axis ticks
    timeAxis.innerHTML="";
    const step = state.slot; // 分刻み（5/10/15）
    for(let m=0; m<=durMin; m+=step){
      const y = m*pxPerMin();
      const tick=document.createElement('div');
      tick.className='tick' + (((m + (win.start.getMinutes()%60))%60===0)?' hour':'');
      tick.style.top = y + "px";
      timeAxis.appendChild(tick);
      // hour label
      const abs = new Date(+win.start + m*60000);
      if(abs.getMinutes()===0){
        const lab=document.createElement('div');
        lab.className='label';
        lab.style.top = (y) + "px";
        lab.textContent = `${pad(abs.getHours())}:${pad(abs.getMinutes())}`;
        timeAxis.appendChild(lab);
      }
    }

    // reposition special lines
    placeDepartLine();
    placeNowLine();

    // rebuild event cards
    document.querySelectorAll('.memberCol').forEach((col,i)=>{
      // 既存カード削除（ヘッダ除く）
      col.querySelectorAll('.card').forEach(el=>el.remove());
    });
    state.events.forEach(ev=> addCard(ev));
  }

  function placeDepartLine(){
    const win=getWindow();
    const y = ((+new Date(state.departAt) - +win.start)/60000) * pxPerMin();
    departLine.style.top = y + "px";
    departHandle.style.top = (y - 26) + "px";
    departHandle.textContent = "出発 " + fmtHM(new Date(state.departAt));
    // meta
    const dep = new Date(state.departAt);
    departText.textContent = `${fmtHM(dep)}（−2h〜＋1h表示）`;
  }

  function placeNowLine(){
    const win=getWindow();
    const now=new Date();
    const y = clamp(((+now - +win.start)/60000) * pxPerMin(), -1000, (+win.end - +win.start)/60000 * pxPerMin());
    nowLine.style.top = y + "px";
  }
  setInterval(placeNowLine, 60000); // 1分更新

  // ----- Cards -----
  function addCard(ev){
    const col = document.querySelectorAll('.memberCol')[ev.memberIndex+1-1]; // grid の1列目は時間軸
  }

  // 修正：grid内の列インデックス対応
  function memberCol(index){ // 0..3
    return document.querySelectorAll('.memberCol')[index];
  }

  function addCard(ev){
    const col = memberCol(ev.memberIndex);
    const win=getWindow();
    const y0 = ((ev.start - +win.start)/60000) * pxPerMin();
    const h  = ((ev.end   - ev.start)/60000) * pxPerMin();

    const card=document.createElement('div');
    card.className='card';
    card.style.top = y0 + "px";
    card.style.height = Math.max(h, pxPerMin()*10) + "px";
    card.dataset.id = ev.id;
    card.innerHTML = `<div>${ev.title}</div><div class="sub">${members[ev.memberIndex]}</div><div class="resize"></div>`;

    // drag move
    let dragStartY=null, origTop=null, pointerId=null, resizing=false, origHeight=null;
    const onPointerDown=(e)=>{
      e.preventDefault(); card.setPointerCapture(e.pointerId);
      pointerId=e.pointerId; dragStartY=e.clientY; origTop=parseFloat(card.style.top); origHeight=parseFloat(card.style.height);
      resizing = e.target.classList.contains('resize');
      card.classList.add('dragging');
    };
    const onPointerMove=(e)=>{
      if(pointerId!==e.pointerId) return;
      if(dragStartY==null) return;
      const dy=e.clientY - dragStartY;
      if(!resizing){
        let ny=origTop + dy;
        // snap to slot
        const slot = state.slot * pxPerMin();
        ny = Math.round(ny/slot)*slot;
        card.style.top = ny + "px";
      }else{
        let nh = origHeight + dy;
        const slot = state.slot * pxPerMin();
        nh = Math.max(slot, Math.round(nh/slot)*slot);
        card.style.height = nh + "px";
      }
    };
    const onPointerUp=(e)=>{
      if(pointerId!==e.pointerId) return;
      card.releasePointerCapture(e.pointerId);
      card.classList.remove('dragging');
      // write back to state
      const ny=parseFloat(card.style.top);
      const nh=parseFloat(card.style.height);
      const startMs = +getWindow().start + (ny/pxPerMin())*60000;
      const endMs   = startMs + (nh/pxPerMin())*60000;
      const s = state.events.find(x=>x.id===ev.id);
      if(s){ s.start=startMs; s.end=endMs; save(); }
      dragStartY=null; pointerId=null; resizing=false;
    };
    card.addEventListener('pointerdown', onPointerDown);
    card.addEventListener('pointermove', onPointerMove);
    card.addEventListener('pointerup', onPointerUp);

    // long press delete
    let pressTimer=null;
    const startPress=()=>{ pressTimer=setTimeout(()=>{ if(confirm('このカードを削除しますか？')){ state.events=state.events.filter(x=>x.id!==ev.id); card.remove(); save(); } },600); };
    const cancelPress=()=>clearTimeout(pressTimer);
    card.addEventListener('pointerdown', startPress);
    card.addEventListener('pointerup', cancelPress);
    card.addEventListener('pointercancel', cancelPress);

    col.appendChild(card);
  }

  // drag from tag to column -> create card
  function startDragFromTag(e, title){
    e.preventDefault();
    const ghost=document.createElement('div');
    ghost.className='card ghost';
    ghost.style.top='-1000px'; ghost.style.height=(pxPerMin()*10)+'px';
    ghost.innerHTML = `<div>${title}</div><div class="sub">ドラッグで配置</div>`;
    grid.appendChild(ghost);

    let active=false, overColIndex=null;

    const onMove=(clientX, clientY)=>{
      const rect=grid.getBoundingClientRect();
      ghost.style.left = (clientX - rect.left - 80) + 'px';
      ghost.style.top  = (clientY - rect.top - 24) + 'px';

      // detect which member column
      overColIndex = -1;
      document.querySelectorAll('.memberCol').forEach((col,idx)=>{
        const r=col.getBoundingClientRect();
        if(clientX>r.left && clientX<r.right && clientY>r.top && clientY<r.bottom){ overColIndex=idx; }
      });
      active=true;
    };

    const onUp=(clientX, clientY)=>{
      document.removeEventListener('mousemove', mouseMove);
      document.removeEventListener('mouseup', mouseUp);
      window.removeEventListener('touchmove', touchMove);
      window.removeEventListener('touchend', touchEnd);
      ghost.remove();

      if(!active || overColIndex===-1) return;
      const col = memberCol(overColIndex);
      const r=col.getBoundingClientRect();
      const y=clamp(clientY - r.top, 0, r.height);
      // snap
      const slotPx = state.slot * pxPerMin();
      const ny = Math.round(y/slotPx)*slotPx;

      const start = +getWindow().start + (ny/pxPerMin())*60000;
      const end   = start + state.slot*60000; // デフォ1スロット
      const ev = { id:crypto.randomUUID(), memberIndex:overColIndex, title, start, end };
      state.events.push(ev); save(); addCard(ev);
    };

    const mouseMove=(e)=>onMove(e.clientX,e.clientY);
    const mouseUp  =(e)=>onUp(e.clientX,e.clientY);
    const touchMove=(e)=>{ const t=e.touches[0]; onMove(t.clientX,t.clientY); };
    const touchEnd =(e)=>{ const t=(e.changedTouches||e.touches)[0]; if(!t){ ghost.remove(); return; } onUp(t.clientX,t.clientY); };

    document.addEventListener('mousemove', mouseMove);
    document.addEventListener('mouseup', mouseUp);
    window.addEventListener('touchmove', touchMove, {passive:false});
    window.addEventListener('touchend', touchEnd, {passive:false});
  }

  // ----- Depart handle drag -----
  (()=> {
    let pid=null, startY=null, startTop=null;
    const down=(e)=>{ e.preventDefault(); departHandle.setPointerCapture(e.pointerId); pid=e.pointerId; startY=e.clientY; startTop=parseFloat(departHandle.style.top)||0; };
    const move=(e)=>{
      if(pid!==e.pointerId) return;
      const dy=e.clientY-startY;
      const slotPx = state.slot * pxPerMin();
      const ny=Math.round((startTop+dy)/slotPx)*slotPx;
      departHandle.style.top = ny+"px";
      departLine.style.top = (ny+26)+"px";
    };
    const up=(e)=>{
      if(pid!==e.pointerId) return;
      departHandle.releasePointerCapture(e.pointerId);
      pid=null;
      // compute new depart time
      const win=getWindow();
      const y=parseFloat(departLine.style.top);
      const newDep = +win.start + (y/pxPerMin())*60000;
      if (newDep !== state.departAt){
        if(confirm("時間変更を通知しますか？")){
          state.departAt = newDep; save();
          rebuildGrid(); placeDepartLine();
          showToast("出発時間を更新しました（通知は後でPush対応）");
        }else{
          rebuildGrid(); // 戻す
        }
      }
    };
    departHandle.addEventListener('pointerdown', down);
    departHandle.addEventListener('pointermove', move);
    departHandle.addEventListener('pointerup', up);
  })();

  // ----- Header inputs -----
  saveBtn.addEventListener('click', ()=>{
    state.place = placeEl.value.trim();
    state.purpose = purposeEl.value.trim();
    const hm = departEl.value || fmtHM(new Date(state.departAt));
    state.departAt = +parseHM(hm, new Date(state.departAt));
    save(); rebuildGrid(); showToast("保存しました");
  });
  slotSelect.addEventListener('change', ()=>{
    state.slot = Number(slotSelect.value)||10; save(); rebuildGrid();
  });
  resetBtn.addEventListener('click', ()=>{
    if(confirm('全てのカードと設定を削除しますか？')){
      state.events=[]; save(); rebuildGrid();
    }
  });
  shareBtn.addEventListener('click', ()=>{
    const data = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(state)))));
    const url = location.origin+location.pathname+'?state='+data;
    navigator.clipboard.writeText(url).then(()=> showToast("共有リンクをコピーしました"));
  });

  // ----- Import via URL -----
  (function importFromQuery(){
    const p=new URLSearchParams(location.search).get('state');
    if(p){
      try{
        const obj=JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(p)))));
        // 既存に上書き
        state=obj; save(); history.replaceState({},"",location.pathname);
      }catch(e){}
    }
  })();

  // ----- Init -----
  function init(){
    load();
    // initial members already fixed
    placeEl.value = state.place||"";
    purposeEl.value = state.purpose||"";
    const dep = new Date(state.departAt);
    departEl.value = pad(dep.getHours())+":"+pad(dep.getMinutes());
    slotSelect.value = String(state.slot||10);
    rebuildTags();
    rebuildGrid();
  }
  init();

})();
</script>
</body>
</html>
